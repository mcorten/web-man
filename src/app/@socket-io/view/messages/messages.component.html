<div class="send-request">
  <ng-container *ngIf="messages | async as _messageCollection">
    <mat-drawer-container>
      <mat-drawer
        mode="over"
        [opened]="(drawerOpen | async) ?? false"
        [disableClose]="true"
      >
        <h3>
          Send message
          <mat-icon
            *ngIf="_messageCollection.length > 0"
            (click)="drawerOpen.next(false)"
            aria-hidden="false"
            aria-label="Add Request"
            fontIcon="close_outline"></mat-icon>
        </h3>
        <form
          class="form"
          [formGroup]="sendRequestForm"
          (submit)="requestForm()"
        >
          <mat-form-field>
            <mat-label>Name</mat-label>
            <input
              matInput
              type="text"
              [formControl]="sendRequestForm.controls.name"
              placeholder="Ex. Enable item (acceptance)">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Event</mat-label>
            <input
              matInput
              type="text"
              [formControl]="sendRequestForm.controls.event"
              placeholder="Ex. Test">
          </mat-form-field>
          <mat-form-field class="body">
            <mat-label>Body</mat-label>
            <textarea

              rows="15"
              matInput
              type="text"
              [formControl]="sendRequestForm.controls.body"
              placeholder='Ex. {"foo": "bar"}'
            >
                </textarea>
          </mat-form-field>


          <button
            mat-raised-button
            color="primary"
            (click)="drawerOpen.next(false)"
          >
            Send message
          </button>
        </form>
      </mat-drawer>

      <h3>
        Messages
        <mat-icon
          (click)="addMessage()"
          aria-hidden="false"
          aria-label="Add Request"
          fontIcon="add_outline"></mat-icon>
      </h3>
      <div *ngIf="_messageCollection.length > 0">
        <app-message-list
          [messageCollection]="_messageCollection"
          (duplicateMessage)="duplicateMessage($event)"
        ></app-message-list>
      </div>
    </mat-drawer-container>

  </ng-container>
</div>

<div class="history">
  <div class="category-title">
    <h3>History</h3>
    <div
      class="action"
    >
      <mat-icon
        *ngIf="((showHistory | async) ?? []).length > 0"
        (click)="removeAllHistory()"
        aria-hidden="false"
        aria-label="Remove history message"
        fontIcon="delete_outline"></mat-icon>
    </div>
  </div>
  <ng-container *ngIf="showHistory | async as _history">
    <div class="message" *ngFor="let historyId of _history">
      <mat-accordion multi>
        <ng-container *ngIf="(historyDetail(historyId) | async) as detail">
          <mat-expansion-panel *ngIf="detail.reply">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span *ngIf="detail.isRequestReply">
                  Reply
                </span>
                <span *ngIf="detail.isUpdate">
                  Update
                </span>
              </mat-panel-title>
              <mat-panel-description
                class="description"
              >
                <span
                  class="name"
                >
                  {{ detail.reply.event }}
                </span>
                <div
                  class="action"
                >
                  <button
                    *ngIf="isString(detail.reply.body)"
                    mat-icon-button
                    [cdkCopyToClipboard]="detail.reply.body"
                    (click)="$event.stopPropagation();"
                  >
                    <mat-icon
                      *ngIf="detail.isRequestReply"
                      aria-hidden="false"
                      aria-label="Copy history reply to clipboard"
                      fontIcon="content_copy"
                    ></mat-icon>
                    <mat-icon
                      *ngIf="detail.isUpdate"
                      aria-hidden="false"
                      aria-label="Copy history update to clipboard"
                      fontIcon="content_copy"
                    ></mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="$event.stopPropagation(); removeHistoryMessage(historyId)"
                  >
                    <mat-icon
                      aria-hidden="false"
                      aria-label="Remove history message"
                      fontIcon="delete_outline"
                    ></mat-icon>
                  </button>
                </div>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <app-json-view
              [data]="detail.reply.body"
            ></app-json-view>
          </mat-expansion-panel>


          <mat-expansion-panel *ngIf="detail.request">
            <mat-expansion-panel-header>
              <mat-panel-title>
                Request
              </mat-panel-title>
              <mat-panel-description class="description">
                <span class="name">
                  {{ detail.request.event }}
                </span>
                <div class="action">
                  <button
                    *ngIf="isString(detail.request.body)"
                    mat-icon-button
                    [cdkCopyToClipboard]="detail.request.body"
                    (click)="$event.stopPropagation();"
                  >
                    <mat-icon
                      aria-hidden="false"
                      aria-label="Copy history request to clipboard"
                      fontIcon="content_copy"
                    ></mat-icon>
                  </button>
                  <button
                    [style.visibility]="(detail.isRequestReply) ? 'hidden' : 'inherit'"
                    mat-icon-button
                    (click)="$event.stopPropagation(); removeHistoryMessage(detail.id)"
                  >
                    <mat-icon aria-hidden="false" aria-label="Remove history message"
                              fontIcon="delete_outline"></mat-icon>
                  </button>
                </div>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <app-json-view
              [data]="detail.request.body"
            ></app-json-view>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </div>
  </ng-container>
</div>
